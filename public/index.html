 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interactive AI Teaching Assistant</title>
  <style>
    /* Your existing CSS remains the same */
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
      color: #333;
    }
    header {
      background: #2ecc71;
      color: white;
      padding: 20px;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.8rem;
    }
    main {
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
    }
    section {
      background: #e8f5e9;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #a5d6a7;
      margin-bottom: 20px;
    }
    h2 {
      margin-top: 0;
      font-size: 1.3rem;
      color: #2e7d32;
    }
    label {
      font-weight: 600;
      display: block;
      margin-top: 12px;
      margin-bottom: 5px;
      color: #2e7d32;
    }
    input, textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #81c784;
      font-size: 1rem;
      background: #fff;
      box-sizing: border-box;
    }
    #originalDescription, #customDescription {
      min-height: 100px;
      resize: vertical;
    }
    #subtopic {
      max-width: 400px;
    }
    button {
      margin-top: 15px;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      background: #2ecc71;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s ease;
    }
    button:hover {
      background: #27ae60;
    }
    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }
    .question-item {
      background: #c8e6c9;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
      border-left: 4px solid #2e7d32;
    }
    video {
      display: block;
      width: 100%;
      border-radius: 12px;
      margin-top: 15px;
    }
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      align-items: center;
    }
    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #4CAF50;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

       /* ‚úÖ NEW: Advanced Animated Subtitle Styles */
    .subtitles-container {
        position: absolute;
        bottom: 100px;
        left: 0;
        right: 0;
        text-align: center;
        z-index: 1000;
        pointer-events: none;
        display: none;
    }
    
    .subtitle-line {
        display: inline-block;
        background: rgba(0, 0, 0, 0.75);
        color: white;
        padding: 16px 28px;
        border-radius: 16px;
        font-size: 1.5rem;
        font-weight: 500;
        margin: 10px 0;
        backdrop-filter: blur(15px);
        border: 3px solid rgba(46, 204, 113, 0.3);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        animation: subtitleAppear 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        max-width: 85%;
        line-height: 1.6;
        transform-origin: center;
    }
    
    .subtitle-word {
        display: inline-block;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .subtitle-word.highlighted {
        color: #2ecc71;
        font-weight: bold;
        text-shadow: 0 0 15px rgba(46, 204, 113, 0.7);
        transform: scale(1.1);
        animation: wordPulse 0.5s ease infinite alternate;
    }
    
    .subtitle-word.important {
        color: #f39c12;
        font-style: italic;
        text-shadow: 0 0 10px rgba(243, 156, 18, 0.5);
    }
    
    .subtitle-word.question {
        color: #3498db;
        font-weight: bold;
        background: rgba(52, 152, 219, 0.15);
        padding: 2px 6px;
        border-radius: 6px;
        border: 1px solid rgba(52, 152, 219, 0.3);
    }
    
    /* Animations */
    @keyframes subtitleAppear {
        0% {
            opacity: 0;
            transform: translateY(40px) scale(0.9);
        }
        70% {
            transform: translateY(-5px) scale(1.02);
        }
        100% {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    
    @keyframes wordPulse {
        0% {
            text-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
            transform: scale(1);
        }
        100% {
            text-shadow: 0 0 20px rgba(46, 204, 113, 0.9);
            transform: scale(1.15);
        }
    }
    
    @keyframes glowEffect {
        0%, 100% { 
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.3),
                        inset 0 0 20px rgba(46, 204, 113, 0.1);
        }
        50% { 
            box-shadow: 0 0 30px rgba(46, 204, 113, 0.6),
                        inset 0 0 30px rgba(46, 204, 113, 0.2);
        }
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-5px); }
    }
    
    .subtitle-line.float {
        animation: float 3s ease-in-out infinite;
    }
    
    .subtitle-line.glow {
        animation: glowEffect 2s ease-in-out infinite;
    }

    /* Video container for positioning */
    .video-container {
        position: relative;
        margin-top: 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* ‚úÖ NEW: Interactive Session Styles */
    #interactiveSession {
      display: none;
      background: #ffffff;
      border: 2px solid #4CAF50;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }
    #currentQuestion {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 15px;
      color: #2e7d32;
    }
    #microphoneStatus {
      text-align: center;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      font-weight: bold;
    }
    .mic-listening {
      background: #fff3cd;
      border: 2px solid #ffc107;
      color: #856404;
    }
    .mic-processing {
      background: #d1ecf1;
      border: 2px solid #17a2b8;
      color: #0c5460;
    }
    .mic-success {
      background: #d4edda;
      border: 2px solid #28a745;
      color: #155724;
    }
    .mic-error {
      background: #f8d7da;
      border: 2px solid #dc3545;
      color: #721c24;
    }
    #studentAnswer {
      width: 100%;
      padding: 12px;
      border: 2px solid #81c784;
      border-radius: 8px;
      font-size: 1rem;
      margin: 10px 0;
    }
    #feedbackMessage {
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: center;
      font-weight: bold;
    }
    .feedback-correct {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .feedback-incorrect {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .presenter-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .presenter-option {
      display: flex;
      align-items: center;
      padding: 15px;
      border: 2px solid #81c784;
      border-radius: 10px;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .presenter-option:hover {
      background: #f1f8e9;
      border-color: #4caf50;
    }
    .presenter-option input[type="radio"] {
      margin-right: 15px;
      transform: scale(1.2);
    }
    .presenter-option label {
      display: flex;
      align-items: center;
      cursor: pointer;
      margin: 0;
      width: 100%;
    }
    .status-message {
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: center;
      font-weight: bold;
    }
    .status-processing {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }
    .status-success {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    .status-error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      margin: 10px 0;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #4CAF50;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media(max-width:700px) {
      .two-column {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>üé§ Interactive AI Teaching Assistant</h1>
  </header>

  <main>
    <!-- Lesson Info -->
    <section>
      <h2>Lesson Details</h2>
      <label>Subtopic:</label>
      <input type="text" id="subtopic" readonly />
      <label>Lesson Description:</label>
      <textarea id="originalDescription" readonly></textarea>
      <label>Or Write Your Own:</label>
      <textarea id="customDescription" placeholder="Type your lesson description here..."></textarea>
    </section>

    <!-- Quiz Builder -->
    <section>
      <h2>üìã Interactive Quiz Builder</h2>
      <p style="color: #2e7d32; font-style: italic; margin-bottom: 15px;">
        Students will answer these questions using their microphone!
      </p>
      <div class="two-column">
        <input type="text" id="questionInput" placeholder="Enter question..." />
        <input type="text" id="answerInput" placeholder="Enter correct answer..." />
      </div>
      <button type="button" id="addQuestionBtn">‚ûï Add Interactive Question</button>

      <div id="questionsList">
        <h3>‚úÖ Questions for interactive practice: <span id="questionCount">0</span></h3>
        <div id="addedQuestions"></div>
      </div>
    </section>

    <!-- Presenter Selection -->
    <section>
      <h2>üé≠ Select AI Presenter</h2>
      <div class="presenter-options">
        <div class="presenter-option">
          <input type="radio" id="presenter1" name="presenter" value="v2_public_anita@Os4oKCBIgZ" checked>
          <label for="presenter1">
            <img src="https://clips-presenters.d-id.com/v2/anita/Os4oKCBIgZ/yTLykkbYHr/thumbnail.png" alt="Anita"
              style="width: 80px; height: 80px; border-radius: 8px; margin-right: 10px;">
            <div>
              <strong>Anita</strong><br>
              <span style="font-size: 0.8em; color: #666;">Female - English (Indian)</span>
            </div>
          </label>
        </div>
        <div class="presenter-option">
          <input type="radio" id="presenter2" name="presenter" value="v2_public_lucas@vngv2djh6d">
          <label for="presenter2">
            <img src="https://clips-presenters.d-id.com/v2/lucas/vngv2djh6d/vz7n_w_05r/thumbnail.png" alt="Lucas"
              style="width: 80px; height: 80px; border-radius: 8px; margin-right: 10px;">
            <div>
              <strong>Lucas</strong><br>
              <span style="font-size: 0.8em; color: #666;">Male</span>
            </div>
          </label>
        </div>
      </div>
    </section>

    <!-- Video Section -->
    <section>
      <h2>üé• Lesson Video</h2>
      <button type="button" id="generateVideoBtn">Generate Teaching Video</button>

      <button type="button" id="toggleSubtitlesBtn" style="display: none; margin-left: 10px; background: #3498db;">
        üéØ Toggle Animated Subtitles
      </button>

     <!-- ‚úÖ NEW: Subtitle Effects Buttons -->
      <div id="subtitleEffects" style="display: none; margin-top: 10px;">
        <button type="button" class="effect-btn" data-effect="float" style="margin-right: 5px; background: #9b59b6;">‚ú® Float Effect</button>
        <button type="button" class="effect-btn" data-effect="glow" style="margin-right: 5px; background: #e74c3c;">üî• Glow Effect</button>
        <button type="button" class="effect-btn" data-effect="none" style="background: #95a5a6;">üåÄ Reset Effects</button>
      </div>

      <!-- Status Messages -->
      <div id="statusMessage" style="display: none;"></div>

      <!-- Progress bar -->
      <div id="progressContainer" style="display: none;">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <p id="progressText" style="text-align: center; margin: 5px 0; font-size: 0.9em; color: #666;">Starting...</p>
      </div>

      <video id="video" controls style="display: none;"></video>

      <div id="loadingMessage" style="display:none;text-align:center;margin-top:20px;">
        <div class="spinner"></div>
        <p style="font-size:1.2rem;color:#555;margin-top:10px;">Generating your AI video, please wait...</p>
      </div>

      <button type="button" id="saveLessonBtn" style="display: none;">üíæ Save Lesson to AWS S3</button>
    </section>

    <!-- ‚úÖ NEW: Interactive Session Section -->
    <section id="interactiveSession">
      <h2>üé§ Interactive Practice Session</h2>
      <div id="currentQuestion"></div>
      
      <div id="microphoneStatus" class="mic-listening">
        üé§ Click "Start Listening" and speak your answer
      </div>
      
      <textarea id="studentAnswer" placeholder="Or type your answer here..." style="display: none;"></textarea>
      
      <div style="text-align: center;">
        <button type="button" id="startListeningBtn">üé§ Start Listening</button>
        <button type="button" id="submitAnswerBtn" style="display: none;">‚úÖ Submit Answer</button>
        <button type="button" id="nextQuestionBtn" style="display: none;">‚û°Ô∏è Next Question</button>
      </div>
      
      <div id="feedbackMessage" style="display: none;"></div>
      
      <div id="sessionProgress" style="margin-top: 15px;">
        <p>Progress: <span id="currentQuestionNumber">0</span> of <span id="totalQuestions">0</span></p>
      </div>
    </section>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const urlParams = new URLSearchParams(window.location.search);

      // Get all dynamic fields
      const returnTo = urlParams.get("returnTo") || "/adminright";
      const subtopicId = urlParams.get("subtopicId") || "";
      const parentId = urlParams.get("parentId") || "";
      const rootId = urlParams.get("rootId") || "";
      const dbname = urlParams.get("dbname") || "professional";
      const subjectName = urlParams.get("subjectName") || "";
      const subtopic = urlParams.get("subtopic") || "";
      const description = decodeURIComponent(urlParams.get("description") || "");
      const imageUrls = JSON.parse(urlParams.get("imageUrls") || "[]");
      const audioFileId = JSON.parse(urlParams.get("audioFileId") || "[]");

      console.log("üìã Received parameters:", {
        subtopicId: subtopicId,
        parentId: parentId,
        rootId: rootId,
        dbname: dbname,
        subjectName: subjectName,
        subtopicName: subtopic
      });

      // Fill UI
      document.getElementById("subtopic").value = subtopic;
      document.getElementById("originalDescription").value = description;

      let aiVideoUrl = "";
      const questions = [];
      let currentQuestionIndex = 0;
      let recognition = null;

      // DOM Elements
      const statusMessage = document.getElementById("statusMessage");
      const generateBtn = document.getElementById("generateVideoBtn");
      const saveBtn = document.getElementById("saveLessonBtn");
      const loading = document.getElementById("loadingMessage");
      const video = document.getElementById("video");
      const progressContainer = document.getElementById("progressContainer");
      const progressFill = document.getElementById("progressFill");
      const progressText = document.getElementById("progressText");
      
      // ‚úÖ NEW: Interactive Session Elements
      const interactiveSession = document.getElementById("interactiveSession");
      const currentQuestionEl = document.getElementById("currentQuestion");
      const microphoneStatus = document.getElementById("microphoneStatus");
      const studentAnswer = document.getElementById("studentAnswer");
      const startListeningBtn = document.getElementById("startListeningBtn");
      const submitAnswerBtn = document.getElementById("submitAnswerBtn");
      const nextQuestionBtn = document.getElementById("nextQuestionBtn");
      const feedbackMessage = document.getElementById("feedbackMessage");
      const currentQuestionNumber = document.getElementById("currentQuestionNumber");
      const totalQuestions = document.getElementById("totalQuestions");

           // ‚úÖ NEW: Animated Subtitle Elements
      const video = document.getElementById('video');
      const toggleSubtitlesBtn = document.getElementById('toggleSubtitlesBtn');
      const subtitlesContainer = document.getElementById('subtitlesContainer');
      const subtitleEffects = document.getElementById('subtitleEffects');
      let subtitlePlayer = null;

      // Advanced Subtitle Player Class
      class AnimatedSubtitlePlayer {
          constructor(videoElement, containerElement) {
              this.video = videoElement;
              this.container = containerElement;
              this.subtitles = [];
              this.currentSubtitle = null;
              this.isPlaying = false;
              this.wordInterval = null;
          }
          
          async loadSubtitles(subtitleUrl) {
              try {
                  console.log('üé¨ Loading animated subtitles from:', subtitleUrl);
                  const response = await fetch(subtitleUrl);
                  const vttContent = await response.text();
                  this.parseVTT(vttContent);
                  this.start();
                  return true;
              } catch (error) {
                  console.error('Error loading animated subtitles:', error);
                  return false;
              }
          }
          
          parseVTT(vttContent) {
              const lines = vttContent.split('\n');
              this.subtitles = [];
              
              let currentSubtitle = null;
              
              for (const line of lines) {
                  if (line.includes('-->')) {
                      if (currentSubtitle) this.subtitles.push(currentSubtitle);
                      const [start, end] = line.split(' --> ');
                      currentSubtitle = {
                          start: this.timeToSeconds(start.trim()),
                          end: this.timeToSeconds(end.trim()),
                          text: '',
                          words: []
                      };
                  } else if (currentSubtitle && line.trim() && !line.includes('WEBVTT') && !line.includes('STYLE')) {
                      currentSubtitle.text += line.trim() + ' ';
                  }
              }
              if (currentSubtitle) this.subtitles.push(currentSubtitle);
              
              // Process words for animation
              this.subtitles.forEach(sub => {
                  sub.words = sub.text.trim().split(/\s+/).map((word, index, arr) => {
                      const wordDuration = (sub.end - sub.start) / arr.length;
                      return {
                          text: word,
                          start: sub.start + (index * wordDuration),
                          end: sub.start + ((index + 1) * wordDuration),
                          isImportant: word.includes('?') || 
                                     ['important', 'remember', 'key', 'essential'].some(term => 
                                         word.toLowerCase().includes(term)),
                          isQuestion: word.includes('?')
                      };
                  });
              });
              
              console.log(`üìù Loaded ${this.subtitles.length} animated subtitle entries`);
          }
          
          timeToSeconds(timeStr) {
              const [hms, ms] = timeStr.split('.');
              const [h, m, s] = hms.split(':');
              return parseInt(h) * 3600 + parseInt(m) * 60 + parseInt(s) + parseInt(ms) / 1000;
          }
          
          start() {
              this.container.style.display = 'block';
              this.isPlaying = true;
              
              this.video.addEventListener('timeupdate', () => this.updateSubtitles());
              this.video.addEventListener('play', () => this.isPlaying = true);
              this.video.addEventListener('pause', () => this.isPlaying = false);
              
              // Start word highlighting
              this.startWordHighlighting();
          }
          
          updateSubtitles() {
              if (!this.isPlaying) return;
              
              const currentTime = this.video.currentTime;
              
              // Find current subtitle
              const currentSub = this.subtitles.find(sub => 
                  currentTime >= sub.start && currentTime <= sub.end
              );
              
              if (currentSub && (!this.currentSubtitle || this.currentSubtitle.text !== currentSub.text)) {
                  this.displaySubtitle(currentSub);
                  this.currentSubtitle = currentSub;
              } else if (!currentSub && this.currentSubtitle) {
                  this.clearSubtitle();
                  this.currentSubtitle = null;
              }
          }
          
          displaySubtitle(subtitle) {
              // Create animated subtitle line
              const subtitleLine = document.createElement('div');
              subtitleLine.className = 'subtitle-line';
              
              // Add word highlighting
              subtitleLine.innerHTML = subtitle.words.map(word => 
                  `<span class="subtitle-word ${word.isImportant ? 'important' : ''} ${word.isQuestion ? 'question' : ''}" 
                        data-word="${word.text}">${word.text}</span>`
              ).join(' ');
              
              this.container.innerHTML = '';
              this.container.appendChild(subtitleLine);
              
              // Apply entrance animation
              setTimeout(() => {
                  subtitleLine.style.animation = 'subtitleAppear 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
              }, 50);
          }
          
          startWordHighlighting() {
              clearInterval(this.wordInterval);
              
              this.wordInterval = setInterval(() => {
                  if (!this.isPlaying || !this.currentSubtitle) return;
                  
                  const currentTime = this.video.currentTime;
                  const words = this.container.querySelectorAll('.subtitle-word');
                  
                  // Remove highlight from all words
                  words.forEach(word => word.classList.remove('highlighted'));
                  
                  // Find and highlight current word
                  const currentWord = this.currentSubtitle.words.find(word => 
                      currentTime >= word.start && currentTime <= word.end
                  );
                  
                  if (currentWord && words[currentWord.index]) {
                      const wordElement = Array.from(words).find(el => 
                          el.dataset.word === currentWord.text
                      );
                      if (wordElement) {
                          wordElement.classList.add('highlighted');
                      }
                  }
              }, 100);
          }
          
          clearSubtitle() {
              this.container.innerHTML = '';
          }
          
          applyEffect(effectName) {
              const subtitleLine = this.container.querySelector('.subtitle-line');
              if (!subtitleLine) return;
              
              // Remove all effects first
              subtitleLine.classList.remove('float', 'glow');
              subtitleLine.style.animation = '';
              
              // Apply new effect
              if (effectName !== 'none') {
                  subtitleLine.classList.add(effectName);
              }
          }
          
          stop() {
              clearInterval(this.wordInterval);
              this.container.style.display = 'none';
              this.isPlaying = false;
          }
      }

      // Initialize subtitle player
      subtitlePlayer = new AnimatedSubtitlePlayer(video, subtitlesContainer);

      // Toggle subtitles button handler
      toggleSubtitlesBtn.addEventListener('click', function() {
          if (subtitlesContainer.style.display === 'none') {
              subtitlesContainer.style.display = 'block';
              subtitleEffects.style.display = 'block';
              toggleSubtitlesBtn.textContent = 'üéØ Hide Animated Subtitles';
              toggleSubtitlesBtn.style.background = '#2ecc71';
          } else {
              subtitlesContainer.style.display = 'none';
              subtitleEffects.style.display = 'none';
              toggleSubtitlesBtn.textContent = 'üéØ Show Animated Subtitles';
              toggleSubtitlesBtn.style.background = '#3498db';
          }
      });

      // Subtitle effect buttons
      document.querySelectorAll('.effect-btn').forEach(btn => {
          btn.addEventListener('click', function() {
              const effect = this.dataset.effect;
              subtitlePlayer.applyEffect(effect);
              
              // Update button states
              document.querySelectorAll('.effect-btn').forEach(b => {
                  b.style.opacity = '0.7';
                  b.style.transform = 'scale(0.95)';
              });
              this.style.opacity = '1';
              this.style.transform = 'scale(1)';
          });
      });

      // Check database on page load
  // Check database on page load
// ‚úÖ FIXED: Check if subtopic exists (with proper error handling)
console.log("üîç Checking if subtopic exists in database...");
fetch(`https://d3ty37mf4sf9cz.cloudfront.net/api/find-subtopic/${subtopicId}?dbname=${dbname}&subjectName=${encodeURIComponent(subjectName)}`)
  .then(response => {
    if (!response.ok) {
      console.log("‚ö†Ô∏è Database check HTTP error:", response.status);
      return null; // Return null instead of throwing
    }
    return response.json().catch(() => null); // Handle JSON parse errors
  })
  .then(data => {
    if (data && data.success !== undefined) {
      console.log("üìä Subtopic check result:", data);
      if (data.found) {
        console.log("‚úÖ Subtopic found in database");
        console.log("üìÅ Collection:", data.collection);
        console.log("üìç Location:", data.location);
        console.log("üìù Document:", data.document?.name || data.document?.unitName);
      } else {
        console.log("‚ùå Subtopic not found in database");
        console.log("‚ÑπÔ∏è Message:", data.message);
      }
    } else {
      console.log("‚ö†Ô∏è Database check returned unexpected response:", data);
    }
  })
  .catch(error => {
    console.log("‚ö†Ô∏è Database check failed (non-critical):", error.message);
    // This is non-critical, continue with video generation
  });

      // Add interactive quiz question
      document.getElementById("addQuestionBtn").addEventListener("click", () => {
        const q = document.getElementById("questionInput").value.trim();
        const a = document.getElementById("answerInput").value.trim();

        if (!q || !a) {
          alert("Please enter both question & answer");
          return;
        }

        questions.push({ question: q, answer: a });

        // Clear inputs
        document.getElementById("questionInput").value = "";
        document.getElementById("answerInput").value = "";

        // Update UI
        updateQuestionsDisplay();

        alert(`‚úÖ Interactive question added!\n\nStudents will answer this using voice or text!`);
      });

      function updateQuestionsDisplay() {
        const container = document.getElementById("addedQuestions");
        const countElement = document.getElementById("questionCount");

        // Update count
        countElement.textContent = questions.length;

        // Clear and rebuild questions list
        container.innerHTML = '';

        questions.forEach((item, index) => {
          const div = document.createElement("div");
          div.className = "question-item";
          div.innerHTML = `
            <strong>Q${index + 1}:</strong> ${item.question}<br/>
            <strong>A:</strong> ${item.answer}
            <button onclick="removeQuestion(${index})" style="margin-left: 10px; background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Remove</button>
          `;
          container.appendChild(div);
        });
      }

      // Add remove question function
      window.removeQuestion = function (index) {
        if (confirm("Remove this question from the video?")) {
          questions.splice(index, 1);
          updateQuestionsDisplay();
        }
      };

      function showStatus(message, type = 'processing') {
        statusMessage.innerHTML = message;
        statusMessage.className = `status-message status-${type}`;
        statusMessage.style.display = 'block';
      }

      function hideStatus() {
        statusMessage.style.display = 'none';
      }

      function updateProgress(percent, text) {
        progressFill.style.width = `${percent}%`;
        progressText.textContent = text;
      }

      // ‚úÖ MODIFIED: Generate teaching video (without interactive parts)
      document.getElementById("generateVideoBtn").addEventListener("click", async () => {
        const desc = document.getElementById("customDescription").value.trim() || description;
        const selectedPresenter = document.querySelector('input[name="presenter"]:checked').value;

        if (!desc.trim()) {
          alert("Please enter a description for the AI video");
          return;
        }

        // UI State
        generateBtn.disabled = true;
        generateBtn.textContent = "Generating...";
        loading.style.display = "block";
        video.style.display = "none";
        saveBtn.style.display = "none";
        interactiveSession.style.display = "none";
        progressContainer.style.display = "block";
        hideStatus();
        updateProgress(10, "Starting video generation...");

        try {
          console.log("üé¨ Starting teaching video generation");

          // Create teaching-only script (no questions in video)
          let teachingScript = desc;
          // teachingScript += "\n\nNow, let's practice what you've learned with some interactive questions.";

          console.log("üìù Teaching script prepared");

          // Step 1: Start video generation
          updateProgress(20, "Initializing D-ID API...");
          const startResponse = await fetch("https://d3ty37mf4sf9cz.cloudfront.net/generate-and-upload", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              subtopic: subtopic,
              description: teachingScript,
              questions: [], // No questions in video - they'll be interactive
              presenter_id: selectedPresenter
            })
          });

          if (!startResponse.ok) {
            const errorText = await startResponse.text();
            throw new Error(`Failed to start video: HTTP ${startResponse.status}`);
          }

          const startData = await startResponse.json();
          console.log("‚úÖ Generation started:", startData);

          const jobId = startData.job_id;

          showStatus(
            `üîÑ Teaching video generation started!<br>
            üìù <strong>${startData.subtopic}</strong><br>
            ‚è≥ This may take 2-3 minutes...`,
            'processing'
          );

          // Step 2: Poll for job completion
          let jobCompleted = false;
          let pollCount = 0;
          const MAX_POLLS = 60;

          updateProgress(30, "Creating teaching video...");

          while (!jobCompleted && pollCount < MAX_POLLS) {
            await new Promise(r => setTimeout(r, 3000));
            pollCount++;

            try {
              updateProgress(30 + (pollCount / MAX_POLLS) * 60, `Processing video... (${pollCount}/${MAX_POLLS})`);

              const statusResponse = await fetch(`https://d3ty37mf4sf9cz.cloudfront.net/api/job-status/${jobId}`);

              if (!statusResponse.ok) {
                console.warn(`‚ö†Ô∏è Status check ${pollCount} failed: HTTP ${statusResponse.status}`);
                continue;
              }

              const jobStatus = await statusResponse.json();
              console.log(`üìä Job status ${pollCount}:`, jobStatus.status);

              if (jobStatus.status === 'completed') {
                // ‚úÖ VIDEO READY!
                aiVideoUrl = jobStatus.videoUrl;
                console.log("‚úÖ Teaching video ready:", aiVideoUrl);

                if (!aiVideoUrl) {
                  throw new Error("No video URL in completed job");
                }

                // Store video URL and show in UI
                localStorage.setItem("generatedAIVideoUrl", aiVideoUrl);

                // Show video and enable buttons
                               // Show video and enable buttons
                video.style.display = "block";
                video.src = aiVideoUrl;
                
                // ‚úÖ NEW: Load animated subtitles
                if (aiVideoUrl && aiVideoUrl.includes('amazonaws.com')) {
                    const subtitleUrl = aiVideoUrl.replace('.mp4', '.vtt');
                    console.log('üîç Looking for animated subtitles at:', subtitleUrl);
                    
                    // Try to load animated subtitles
                    fetch(subtitleUrl, { method: 'HEAD' })
                        .then(response => {
                            if (response.ok) {
                                console.log('‚úÖ Animated subtitles found!');
                                subtitlePlayer.loadSubtitles(subtitleUrl).then(success => {
                                    if (success) {
                                        toggleSubtitlesBtn.style.display = 'inline-block';
                                        subtitleEffects.style.display = 'block';
                                        console.log('üé¨ Animated subtitles loaded successfully!');
                                    }
                                });
                            } else {
                                console.log('‚ö†Ô∏è No animated subtitles found');
                            }
                        })
                        .catch(err => {
                            console.log('‚ö†Ô∏è Could not check for animated subtitles:', err.message);
                        });
                }
                
                saveBtn.style.display = "block";
                
                // Show interactive session if there are questions
                if (questions.length > 0) {
                  interactiveSession.style.display = "block";
                  startInteractiveSession();
                }
                
                progressContainer.style.display = "none";

                showStatus(
                  `‚úÖ Teaching video generated successfully!<br>
                  üé≠ Presenter: ${selectedPresenter}<br>
                  ‚ùì ${questions.length} interactive questions ready`,
                  'success'
                );

                alert(`‚úÖ Teaching video generated! ${questions.length > 0 ? 'Start the interactive session to practice questions.' : ''}`);
                jobCompleted = true;
                break;

              } else if (jobStatus.status === 'failed') {
                throw new Error(jobStatus.error || "Video generation failed");
              }

              showStatus(
                `üîÑ Video generation in progress...<br>
                üìù <strong>${subtopic}</strong><br>
                üîÑ ${jobStatus.progress || 'Processing...'}<br>
                ‚è≥ Please wait...`,
                'processing'
              );

            } catch (pollError) {
              console.warn(`‚ö†Ô∏è Poll ${pollCount} failed:`, pollError.message);
            }
          }

          if (!jobCompleted) {
            throw new Error("Video generation took too long. Please try again.");
          }

        } catch (err) {
          console.error("‚ùå AI Video generation error:", err);
          progressContainer.style.display = "none";

          showStatus(
            `‚ùå Generation failed<br>
            ${err.message}`,
            'error'
          );
          alert("‚ùå Failed to generate video: " + err.message);
        } finally {
          // Reset UI state
          loading.style.display = "none";
          generateBtn.disabled = false;
          generateBtn.textContent = "Generate Teaching Video";
        }
      });

      // ‚úÖ NEW: Interactive Session Functions
      function startInteractiveSession() {
        currentQuestionIndex = 0;
        totalQuestions.textContent = questions.length;
        showQuestion(currentQuestionIndex);
      }

      function showQuestion(index) {
        if (index >= questions.length) {
          endSession();
          return;
        }

        const question = questions[index];
        currentQuestionEl.innerHTML = `<strong>Question ${index + 1}:</strong> ${question.question}`;
        currentQuestionNumber.textContent = index + 1;
        
        // Reset UI
        microphoneStatus.className = "mic-listening";
        microphoneStatus.innerHTML = "üé§ Click 'Start Listening' and speak your answer";
        studentAnswer.style.display = "none";
        studentAnswer.value = "";
        startListeningBtn.style.display = "inline-block";
        submitAnswerBtn.style.display = "none";
        nextQuestionBtn.style.display = "none";
        feedbackMessage.style.display = "none";
      }

      function initializeSpeechRecognition() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
          alert("Speech recognition is not supported in this browser. Please use Chrome or Edge.");
          return null;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onstart = function() {
          microphoneStatus.className = "mic-listening";
          microphoneStatus.innerHTML = "üé§ Listening... Speak now!";
        };

        recognition.onresult = function(event) {
          const transcript = event.results[0][0].transcript;
          studentAnswer.value = transcript;
          studentAnswer.style.display = "block";
          startListeningBtn.style.display = "none";
          submitAnswerBtn.style.display = "inline-block";
          
          microphoneStatus.className = "mic-success";
          microphoneStatus.innerHTML = "‚úÖ Speech captured! Click 'Submit Answer' or speak again.";
        };

        recognition.onerror = function(event) {
          console.error("Speech recognition error:", event.error);
          microphoneStatus.className = "mic-error";
          microphoneStatus.innerHTML = `‚ùå Error: ${event.error}. Please type your answer.`;
          studentAnswer.style.display = "block";
          studentAnswer.placeholder = "Please type your answer here...";
          startListeningBtn.style.display = "none";
          submitAnswerBtn.style.display = "inline-block";
        };

        recognition.onend = function() {
          // Auto-restart if still in listening mode
          if (microphoneStatus.classList.contains("mic-listening")) {
            setTimeout(() => {
              if (microphoneStatus.classList.contains("mic-listening")) {
                recognition.start();
              }
            }, 100);
          }
        };

        return recognition;
      }

      // Start listening button
      startListeningBtn.addEventListener("click", () => {
        if (!recognition) {
          recognition = initializeSpeechRecognition();
        }
        
        if (recognition) {
          try {
            recognition.start();
          } catch (error) {
            console.error("Recognition start error:", error);
            microphoneStatus.className = "mic-error";
            microphoneStatus.innerHTML = "‚ùå Cannot access microphone. Please type your answer.";
            studentAnswer.style.display = "block";
            studentAnswer.placeholder = "Please type your answer here...";
            startListeningBtn.style.display = "none";
            submitAnswerBtn.style.display = "inline-block";
          }
        }
      });

      // Submit answer button
      submitAnswerBtn.addEventListener("click", () => {
        const userAnswer = studentAnswer.value.trim();
        if (!userAnswer) {
          alert("Please provide an answer first");
          return;
        }

        evaluateAnswer(userAnswer);
      });

      function evaluateAnswer(userAnswer) {
        const currentQuestion = questions[currentQuestionIndex];
        const correctAnswer = currentQuestion.answer.toLowerCase();
        const userAnswerLower = userAnswer.toLowerCase();

        // Simple evaluation - you can make this more sophisticated
        const isCorrect = userAnswerLower.includes(correctAnswer) || 
                         correctAnswer.includes(userAnswerLower) ||
                         calculateSimilarity(userAnswerLower, correctAnswer) > 0.7;

        // Show feedback
        feedbackMessage.style.display = "block";
        if (isCorrect) {
          feedbackMessage.className = "feedback-correct";
          feedbackMessage.innerHTML = `‚úÖ Correct! Well done!<br>The answer is: ${currentQuestion.answer}`;
        } else {
          feedbackMessage.className = "feedback-incorrect";
          feedbackMessage.innerHTML = `‚ùå Not quite right.<br>The correct answer is: ${currentQuestion.answer}`;
        }

        // Enable next question
        nextQuestionBtn.style.display = "inline-block";
        submitAnswerBtn.style.display = "none";
      }

      // Simple similarity calculation
      function calculateSimilarity(str1, str2) {
        const words1 = str1.split(' ');
        const words2 = str2.split(' ');
        const commonWords = words1.filter(word => words2.includes(word));
        return commonWords.length / Math.max(words1.length, words2.length);
      }

      // Next question button
      nextQuestionBtn.addEventListener("click", () => {
        currentQuestionIndex++;
        showQuestion(currentQuestionIndex);
      });

      function endSession() {
        interactiveSession.innerHTML = `
          <h2>üéâ Session Complete!</h2>
          <div class="feedback-correct" style="padding: 20px; text-align: center;">
            <h3>‚úÖ Excellent work!</h3>
            <p>You've completed all ${questions.length} practice questions.</p>
            <p>Keep up the great learning!</p>
          </div>
          <button type="button" onclick="location.reload()" style="margin-top: 15px;">
            üîÑ Start New Session
          </button>
        `;
      }

      // Save lesson handler (unchanged)
   // In your HTML JavaScript, update the save button handler:
// In your HTML JavaScript, update the save button handler:

// In your HTML JavaScript, update the save button handler:
document.getElementById("saveLessonBtn").addEventListener("click", async () => {
    try {
        const aiVideoUrlToSave = aiVideoUrl || localStorage.getItem("generatedAIVideoUrl");

        if (!aiVideoUrlToSave) {
            alert("Please generate an AI video first before saving");
            return;
        }

        if (!subtopicId) {
            alert("Error: Cannot find subtopic ID to update");
            return;
        }

        console.log("üíæ SAVE LESSON: Uploading to S3 and saving to database");
        console.log("üé¨ Video URL to save:", aiVideoUrlToSave);
        console.log("üìö Subject Name:", subjectName);
        console.log("üÜî Subtopic ID:", subtopicId);

        // Show loading state
        saveBtn.disabled = true;
        const originalText = saveBtn.textContent;
        saveBtn.textContent = "‚òÅÔ∏è Uploading to AWS S3...";
        
        showStatus("‚òÅÔ∏è Step 1: Uploading video to AWS S3...", "processing");
        progressContainer.style.display = "block";
        updateProgress(10, "Starting upload...");

        try {
            // Step 1: Upload to S3
            updateProgress(30, "Uploading to AWS S3...");
            
            const uploadData = {
                videoUrl: aiVideoUrlToSave,
                subtopic: subtopic,
                subtopicId: subtopicId,
                dbname: dbname,
                subjectName: subjectName,
                timestamp: Date.now()
            };
            
            console.log("üì§ Sending to Node.js for S3 upload:", uploadData);

            const uploadResponse = await fetch("https://d3ty37mf4sf9cz.cloudfront.net/api/upload-to-s3-and-save", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                },
                body: JSON.stringify(uploadData),
            });

            console.log("üì• Upload response status:", uploadResponse.status);
            
            if (!uploadResponse.ok) {
                let errorText = await uploadResponse.text();
                console.error("‚ùå Upload error response:", errorText);
                throw new Error(`Upload failed: HTTP ${uploadResponse.status} - ${errorText}`);
            }

            const result = await uploadResponse.json();
            console.log("‚úÖ Upload complete:", result);

            if (result.success) {
                updateProgress(100, "Complete!");
                
                // Clean up
                localStorage.removeItem("generatedAIVideoUrl");

                // Show success message
                let successMessage = `
                    <h3>‚úÖ Video Saved Successfully!</h3>
                    <p><strong>S3 URL:</strong> ${result.s3_url}</p>
                    <p><strong>Database Updated:</strong> ${result.database_updated ? 'Yes' : 'No'}</p>
                    <p><strong>Method:</strong> ${result.update_method}</p>
                `;

                if (result.mongodb_result && result.mongodb_result.message) {
                    successMessage += `<p><strong>Details:</strong> ${result.mongodb_result.message}</p>`;
                }

                if (result.spring_boot_response) {
                    successMessage += `<p><strong>Spring Boot:</strong> ${result.spring_boot_response.message || "Success"}</p>`;
                }

                showStatus(successMessage, 'success');

                // Wait 3 seconds then redirect
                setTimeout(() => {
                    const returnUrl = new URL(returnTo, window.location.origin);
                    returnUrl.searchParams.set("saved", "true");
                    returnUrl.searchParams.set("videoUrl", encodeURIComponent(result.s3_url));
                    returnUrl.searchParams.set("storage", "aws_s3");
                    returnUrl.searchParams.set("dbUpdated", result.database_updated ? "true" : "false");
                    returnUrl.searchParams.set("subtopicId", subtopicId);
                    
                    window.location.href = returnUrl.toString();
                }, 3000);

            } else {
                throw new Error("Save failed: " + (result.error || "Unknown error"));
            }

        } catch (err) {
            console.error("‚ùå Save failed:", err);
            progressContainer.style.display = "none";
            
            // Show detailed error
            let errorMsg = `‚ùå Save failed: ${err.message}`;
            if (err.message.includes("S3")) {
                errorMsg += "<br>‚ö†Ô∏è Check AWS S3 configuration";
            } else if (err.message.includes("database")) {
                errorMsg += `<br>üîç Check if subtopic ID '${subtopicId}' exists in collection '${subjectName}'`;
            }
            
            showStatus(errorMsg, 'error');
            alert("‚ùå Failed to save lesson. Check console for details.");
        } finally {
            // Restore button state
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
            progressContainer.style.display = "none";
        }

    } catch (err) {
        console.error("‚ùå Error in save lesson:", err);
        alert("‚ùå Error saving lesson: " + err.message);
    }
});
    });
  </script>
</body>
</html>
