<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Teaching Assistant</title>
  <style>
    /* Your existing CSS styles */
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
      color: #333;
    }

    header {
      background: #2ecc71;
      color: white;
      padding: 20px;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.8rem;
    }

    main {
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
    }

    section {
      background: #e8f5e9;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #a5d6a7;
      margin-bottom: 20px;
    }

    h2 {
      margin-top: 0;
      font-size: 1.3rem;
      color: #2e7d32;
    }

    label {
      font-weight: 600;
      display: block;
      margin-top: 12px;
      margin-bottom: 5px;
      color: #2e7d32;
    }

    input,
    textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #81c784;
      font-size: 1rem;
      background: #fff;
      box-sizing: border-box;
    }

    #originalDescription,
    #customDescription {
      min-height: 100px;
      resize: vertical;
    }

    #subtopic {
      max-width: 400px;
    }

    button {
      margin-top: 15px;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      background: #2ecc71;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s ease;
    }

    button:hover {
      background: #27ae60;
    }

    .question-item {
      background: #c8e6c9;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
      border-left: 4px solid #2e7d32;
    }

    video {
      display: block;
      width: 100%;
      border-radius: 12px;
      margin-top: 15px;
    }

    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      align-items: center;
    }

    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #4CAF50;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    .presenter-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .presenter-option {
      display: flex;
      align-items: center;
      padding: 15px;
      border: 2px solid #81c784;
      border-radius: 10px;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .presenter-option:hover {
      background: #f1f8e9;
      border-color: #4caf50;
    }

    .presenter-option input[type="radio"] {
      margin-right: 15px;
      transform: scale(1.2);
    }

    .presenter-option label {
      display: flex;
      align-items: center;
      cursor: pointer;
      margin: 0;
      width: 100%;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    @media(max-width:700px) {
      .two-column {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>üìó AI Teaching Assistant</h1>
  </header>

  <main>
    <!-- Lesson Info -->
    <section>
      <h2>Lesson Details</h2>
      <label>Subtopic:</label>
      <input type="text" id="subtopic" readonly />
      <label>Lesson Description:</label>
      <textarea id="originalDescription" readonly></textarea>
      <label>Or Write Your Own:</label>
      <textarea id="customDescription" placeholder="Type your lesson description here..."></textarea>
    </section>

    <!-- Quiz Builder -->
    <!-- Enhanced Quiz Builder -->
    <!-- Enhanced Quiz Builder -->
    <section>
      <h2>üìã Interactive Quiz Builder</h2>
      <p style="color: #2e7d32; font-style: italic; margin-bottom: 15px;">
        The AI will ask these questions and pause for students to answer verbally!
      </p>
      <div class="two-column">
        <input type="text" id="questionInput" placeholder="Enter question..." />
        <input type="text" id="answerInput" placeholder="Enter correct answer..." />
      </div>
      <button type="button" id="addQuestionBtn">‚ûï Add Interactive Question</button>

      <div id="questionsList">
        <h3>‚úÖ Questions for interactive practice: <span id="questionCount">0</span></h3>
        <div id="addedQuestions"></div>
      </div>
    </section>

    <!-- Presenter Selection -->
    <section>
      <h2>üé≠ Select AI Presenter</h2>
      <div class="presenter-options">
        <div class="presenter-option">
          <input type="radio" id="presenter1" name="presenter" value="v2_public_anita@Os4oKCBIgZ" checked>
          <label for="presenter1">
            <img src="https://clips-presenters.d-id.com/v2/anita/Os4oKCBIgZ/yTLykkbYHr/thumbnail.png" alt="Anita"
              style="width: 80px; height: 80px; border-radius: 8px; margin-right: 10px;">
            <div>
              <strong>Anita</strong><br>
              <span style="font-size: 0.8em; color: #666;">Female - English (Indian)</span>
            </div>
          </label>
        </div>

        <div class="presenter-option">
          <input type="radio" id="presenter2" name="presenter" value="v2_public_lucas@vngv2djh6d">
          <label for="presenter2">
            <img src="https://clips-presenters.d-id.com/v2/lucas/vngv2djh6d/vz7n_w_05r/thumbnail.png" alt="Lucas"
              style="width: 80px; height: 80px; border-radius: 8px; margin-right: 10px;">
            <div>
              <strong>Lucas</strong><br>
              <span style="font-size: 0.8em; color: #666;">Male</span>
            </div>
          </label>
        </div>
        <!-- <div class="presenter-option">
          <input type="radio" id="presenter3" name="presenter" value="v2_public_rian_red_jacket_lobby@Lnoj8R5x9r">
          <label for="presenter3">
            <img src="https://clips-presenters.d-id.com/v2/rian_red_jacket_lobby/Lnoj8R5x9r/svJqDZrHtS/thumbnail.png"
              alt="Rian" style="width: 80px; height: 80px; border-radius: 8px; margin-right: 10px;">
            <div>
              <strong>Rian</strong><br>
              <span style="font-size: 0.8em; color: #666;">Male - Red Jacket</span>
            </div>
          </label>
        </div> -->
      </div>
    </section>

    <!-- Video Section -->
    <section>
      <h2>üé• Lesson Video</h2>
      <button type="button" id="generateVideoBtn">Generate Video</button>
      <video id="video" controls></video>
      <div id="loadingMessage" style="display:none;text-align:center;margin-top:20px;">
        <div class="spinner"></div>
        <p style="font-size:1.2rem;color:#555;margin-top:10px;">Generating your AI video, please wait...</p>
      </div>
      <button type="button" id="saveLessonBtn">üíæ Save Lesson (Recursive)</button>
    </section>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const urlParams = new URLSearchParams(window.location.search);

      // get all dynamic fields
      const returnTo = urlParams.get("returnTo") || "/adminright";
      const subtopicId = urlParams.get("subtopicId") || "";
      const parentId = urlParams.get("parentId") || "";
      const rootId = urlParams.get("rootId") || "";
      const dbname = urlParams.get("dbname") || "professional";
      const subjectName = urlParams.get("subjectName") || "";
      const subtopic = urlParams.get("subtopic") || "";
      const description = decodeURIComponent(urlParams.get("description") || "");
      const imageUrls = JSON.parse(urlParams.get("imageUrls") || "[]");
      const audioFileId = JSON.parse(urlParams.get("audioFileId") || "[]");

      console.log("üìã Received parameters:", {
        subtopicId: subtopicId,
        parentId: parentId,
        rootId: rootId,
        dbname: dbname,
        subjectName: subjectName,
        subtopicName: subtopic
      });

      // fill UI
      document.getElementById("subtopic").value = subtopic;
      document.getElementById("originalDescription").value = description;

      let aiVideoUrl = "";
      const questions = [];

      // Check database on page load
      console.log("üîç Checking if subtopic exists in database...");
      fetch(`https://ai-generative-1.onrender.com/api/debug-subtopic/${subtopicId}?dbname=${dbname}`)
        .then(response => response.json())
        .then(data => {
          console.log("üìä Subtopic check result:", data);
          if (data.found) {
            console.log("‚úÖ Subtopic found:", data.subtopic);
          } else {
            console.log("‚ùå Subtopic not found");
          }
        })
        .catch(error => console.error("‚ùå Database check failed:", error));

      // add quiz
      // add quiz question with better feedback
      // add interactive quiz question
      document.getElementById("addQuestionBtn").addEventListener("click", () => {
        const q = document.getElementById("questionInput").value.trim();
        const a = document.getElementById("answerInput").value.trim();

        if (!q || !a) {
          alert("Please enter both question & answer");
          return;
        }

        questions.push({ question: q, answer: a });

        // Clear inputs
        document.getElementById("questionInput").value = "";
        document.getElementById("answerInput").value = "";

        // Update UI
        updateQuestionsDisplay();

        // Show interactive confirmation
        alert(`‚úÖ Interactive question added!\n\nThe AI will ask: "${q}"\nThen pause for the student to answer\nThen say: "The correct answer is: ${a}"`);
      });

      function updateQuestionsDisplay() {
        const container = document.getElementById("addedQuestions");
        const countElement = document.getElementById("questionCount");

        // Update count
        countElement.textContent = questions.length;

        // Clear and rebuild questions list
        container.innerHTML = '';

        questions.forEach((item, index) => {
          const div = document.createElement("div");
          div.className = "question-item";
          div.innerHTML = `
      <strong>Q${index + 1}:</strong> ${item.question}<br/>
      <strong>A:</strong> ${item.answer}
      <button onclick="removeQuestion(${index})" style="margin-left: 10px; background: #e74c3c;">Remove</button>
    `;
          container.appendChild(div);
        });
      }

      // Add remove question function
      window.removeQuestion = function (index) {
        if (confirm("Remove this question from the video?")) {
          questions.splice(index, 1);
          updateQuestionsDisplay();
        }
      };

      // ‚úÖ CORRECT: Generate AI video with presenter selection - KEEP ONLY THIS VERSION
      // ‚úÖ CORRECT: Generate AI video with proper SSML pauses
      document.getElementById("generateVideoBtn").addEventListener("click", async () => {
        const desc = document.getElementById("customDescription").value.trim() || description;
        const loading = document.getElementById("loadingMessage");
        const video = document.getElementById("video");

        // ‚úÖ Get selected presenter
        const selectedPresenter = document.querySelector('input[name="presenter"]:checked').value;
        console.log("üé≠ Selected presenter:", selectedPresenter);

        if (!desc.trim()) {
          alert("Please enter a description for the AI video");
          return;
        }

        // Check if we have questions to include
        if (questions.length === 0) {
          if (!confirm("No quiz questions added. Generate video without questions?")) {
            return;
          }
        }

        loading.style.display = "block";
        video.style.display = "none";

        try {
          console.log("üé¨ Generating interactive AI video with questions:", questions.length);
          console.log("üé≠ Using presenter:", selectedPresenter);

          // Create interactive script with PROPER SSML pauses
          let interactiveScript = desc;

          // Add interactive quiz section if questions exist
          if (questions.length > 0) {
            interactiveScript += "\n\nNow, let me ask you some questions to test your understanding. After each question, I'll pause so you can say your answer out loud, and then I'll tell you if you're correct.\n\n";

            questions.forEach((q, index) => {
              interactiveScript += `Question ${index + 1}: ${q.question}\n`;
              interactiveScript += `<break time="5s"/>\n`; // ‚úÖ PROPER SSML PAUSE
              interactiveScript += `The correct answer is: ${q.answer}. `;

              // Add encouraging feedback
              if (index === questions.length - 1) {
                interactiveScript += `Great job answering all the questions! `;
              } else {
                interactiveScript += `Let's try the next question. `;
              }
              interactiveScript += `\n\n`;
            });

            interactiveScript += "Excellent work! You've completed all the practice questions.";
          }

          console.log("üìù Interactive script with SSML:", interactiveScript);

          // ‚úÖ Send to backend with presenter_id
          const res = await fetch("https://ai-generative-1.onrender.com/generate-and-upload", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              subtopic: subtopic,
              description: interactiveScript,
              questions: questions,
              presenter_id: selectedPresenter  // ‚úÖ This sends the selected presenter
            }),
          });

          const data = await res.json();

          if (!res.ok) {
            throw new Error(data.error || "Video generation failed");
          }

          aiVideoUrl = data.firebase_video_url;
          console.log("‚úÖ Interactive AI Video URL received:", aiVideoUrl);
          console.log("‚úÖ Presenter used:", data.presenter_used);
          console.log("‚úÖ Stored locally:", data.stored_locally || false);
          console.log("‚úÖ Mock video:", data.mock || false);

          if (!aiVideoUrl) {
            throw new Error("No video URL returned from server");
          }

          localStorage.setItem("generatedAIVideoUrl", aiVideoUrl);
          localStorage.setItem("videoQuestions", JSON.stringify(questions));

          loading.style.display = "none";
          video.style.display = "block";

          // ‚úÖ FIXED: Handle both local and external URLs
          if (aiVideoUrl.startsWith('/assets/')) {
            // For local assets, construct full URL
            video.src = `https://ai-generative-1.onrender.com${aiVideoUrl}`;
          } else {
            // For external URLs, use as-is
            video.src = aiVideoUrl;
          }

          // ‚úÖ ADDED: Handle mock video scenario
          if (data.mock) {
            alert(`‚úÖ MOCK: Video URL generated successfully!\n\nThis is a test video URL: ${aiVideoUrl}\n\nYou can now save this URL to the database to test the complete flow.`);
          } else {
            alert(`‚úÖ Interactive AI Video generated with ${data.presenter_used}! It will ask ${questions.length} questions with 5-second pauses for you to answer.`);
          }
        } catch (err) {
          console.error("‚ùå AI Video generation error:", err);
          loading.style.display = "none";

          // ‚úÖ IMPROVED: Better error message for mock videos
          if (err.message.includes("402")) {
            alert("‚ùå D-ID API Credits Exhausted\n\nCurrently using mock video generation for testing.\nThe video URL will be saved to database successfully!");
          } else {
            alert("‚ùå Failed to generate video: " + err.message);
          }
        }
      });

      // ‚úÖ REPLACE YOUR saveLessonBtn CLICK HANDLER WITH THIS:
      document.getElementById("saveLessonBtn").addEventListener("click", async () => {
        try {
          const aiVideoUrlToSave = aiVideoUrl || localStorage.getItem("generatedAIVideoUrl");
          if (!aiVideoUrlToSave) {
            alert("Please generate an AI video first before saving");
            return;
          }

          if (!subtopicId) {
            alert("Error: Cannot find subtopic ID to update");
            return;
          }

          console.log("üíæ SAVE LESSON: Uploading to S3 and saving to DB");
          console.log("üé¨ Video URL:", aiVideoUrlToSave);
          console.log("üìù Subtopic:", subtopic);
          console.log("üÜî Subtopic ID:", subtopicId);

          // Show loading state
          const saveBtn = document.getElementById("saveLessonBtn");
          const originalText = saveBtn.textContent;
          saveBtn.textContent = "‚òÅÔ∏è Uploading to AWS S3...";
          saveBtn.disabled = true;

          try {
            // Upload to S3 and save to database
            console.log("üöÄ Calling S3 upload endpoint...");
            const uploadResponse = await fetch("https://ai-generative-1.onrender.com/api/upload-to-s3-and-save", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                videoUrl: aiVideoUrlToSave,
                subtopic: subtopic,
                subtopicId: subtopicId,
                parentId: parentId,
                rootId: rootId,
                dbname: dbname,
                subjectName: subjectName
              }),
            });

            if (!uploadResponse.ok) {
              const errorText = await uploadResponse.text();
              throw new Error(`S3 upload failed: HTTP ${uploadResponse.status}: ${errorText}`);
            }

            const uploadData = await uploadResponse.json();
            console.log("‚úÖ S3 Upload and Save response:", uploadData);

            if (uploadData.success) {
              localStorage.removeItem("generatedAIVideoUrl");

              alert(`üéâ Video saved successfully!\n\n‚úÖ Uploaded to AWS S3\n‚úÖ S3 URL: ${uploadData.s3_url}\n‚úÖ Saved to database`);

              // Add success parameters to return URL
              const returnUrl = new URL(returnTo, window.location.origin);
              returnUrl.searchParams.set("saved", "true");
              returnUrl.searchParams.set("message", "AI+video+uploaded+to+AWS+S3+successfully");
              returnUrl.searchParams.set("videoUrl", encodeURIComponent(uploadData.s3_url));
              returnUrl.searchParams.set("storage", "aws_s3");

              window.location.href = returnUrl.toString();
            } else {
              throw new Error("S3 upload succeeded but database save failed: " + uploadData.error);
            }

          } catch (err) {
            console.error("‚ùå S3 Upload failed:", err);
            alert("‚ùå Failed to upload video to AWS S3: " + err.message);
          } finally {
            // Restore button state
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
          }

        } catch (err) {
          console.error("‚ùå Error in save lesson:", err);
          alert("‚ùå Error saving lesson: " + err.message);

          // Restore button state
          const saveBtn = document.getElementById("saveLessonBtn");
          saveBtn.textContent = "üíæ Save Lesson (AWS S3)";
          saveBtn.disabled = false;
        }
      });

      // Helper function for fallback update
      async function tryFallbackUpdate(aiVideoUrlToSave) {
        try {
          console.log("üîÑ Trying fallback update method...");
          const fallbackResponse = await fetch("https://ai-generative-1.onrender.com/api/updateSubtopicVideo", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              rootId: rootId,
              parentId: parentId,
              subtopicId: subtopicId,
              aiVideoUrl: aiVideoUrlToSave,
              dbname: dbname,
              subjectName: subjectName
            }),
          });

          if (!fallbackResponse.ok) {
            const errorText = await fallbackResponse.text();
            throw new Error(`Fallback failed: HTTP ${fallbackResponse.status}: ${errorText}`);
          }

          const fallbackData = await fallbackResponse.json();
          console.log("‚úÖ Fallback save response:", fallbackData);

          if (fallbackData.updated > 0 || fallbackData.status === "ok") {
            localStorage.removeItem("generatedAIVideoUrl");
            alert("‚úÖ AI Video saved successfully (using fallback method)!");
            window.location.href = returnTo + "?saved=true&message=Video+saved+with+fallback";
          } else {
            throw new Error("Both recursive and fallback methods failed to update any documents");
          }

        } catch (fallbackErr) {
          console.error("‚ùå Fallback also failed:", fallbackErr);
          throw new Error(`All save methods failed: ${fallbackErr.message}`);
        }
      }
    });
  </script>
</body>

</html>
