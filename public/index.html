<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interactive AI Teaching Assistant - HeyGen</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
      color: #333;
    }
    header {
      background: #2ecc71;
      color: white;
      padding: 20px;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.8rem;
    }
    main {
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
    }
    section {
      background: #e8f5e9;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #a5d6a7;
      margin-bottom: 20px;
    }
    h2 {
      margin-top: 0;
      font-size: 1.3rem;
      color: #2e7d32;
    }
    label {
      font-weight: 600;
      display: block;
      margin-top: 12px;
      margin-bottom: 5px;
      color: #2e7d32;
    }
    input, textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #81c784;
      font-size: 1rem;
      background: #fff;
      box-sizing: border-box;
    }
    #originalDescription, #customDescription {
      min-height: 100px;
      resize: vertical;
    }
    #subtopic {
      max-width: 400px;
    }
    button {
      margin-top: 15px;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      background: #2ecc71;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s ease;
    }
    button:hover {
      background: #27ae60;
    }
    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }
    .question-item {
      background: #c8e6c9;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
      border-left: 4px solid #2e7d32;
    }
    video {
      display: block;
      width: 100%;
      border-radius: 12px;
      margin-top: 15px;
    }
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      align-items: center;
    }
    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #4CAF50;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    /* HeyGen Avatar Selection */
    .avatar-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .avatar-option {
      display: flex;
      align-items: center;
      padding: 15px;
      border: 2px solid #81c784;
      border-radius: 10px;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .avatar-option:hover {
      background: #f1f8e9;
      border-color: #4caf50;
    }
    .avatar-option input[type="radio"] {
      margin-right: 15px;
      transform: scale(1.2);
    }
    .avatar-option label {
      display: flex;
      align-items: center;
      cursor: pointer;
      margin: 0;
      width: 100%;
    }
    
    /* Status Messages */
    .status-message {
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: center;
      font-weight: bold;
    }
    .status-processing {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }
    .status-success {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    .status-error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      margin: 10px 0;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #4CAF50;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media(max-width:700px) {
      .two-column {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>ü§ñ Interactive AI Teaching Assistant - HeyGen</h1>
  </header>

  <main>
    <!-- Lesson Info -->
    <section>
      <h2>Lesson Details</h2>
      <label>Subtopic:</label>
      <input type="text" id="subtopic" readonly />
      <label>Lesson Description:</label>
      <textarea id="originalDescription" readonly></textarea>
      <label>Or Write Your Own:</label>
      <textarea id="customDescription" placeholder="Type your lesson description here..."></textarea>
    </section>

    <!-- Quiz Builder -->
    <section>
      <h2>üìã Interactive Quiz Builder</h2>
      <p style="color: #2e7d32; font-style: italic; margin-bottom: 15px;">
        Add questions for interactive practice after the video
      </p>
      <div class="two-column">
        <input type="text" id="questionInput" placeholder="Enter question..." />
        <input type="text" id="answerInput" placeholder="Enter correct answer..." />
      </div>
      <button type="button" id="addQuestionBtn">‚ûï Add Interactive Question</button>

      <div id="questionsList">
        <h3>‚úÖ Questions for interactive practice: <span id="questionCount">0</span></h3>
        <div id="addedQuestions"></div>
      </div>
    </section>

    <!-- HeyGen Avatar Selection -->
    <section>
      <h2>ü§ñ Select AI Avatar (HeyGen)</h2>
      <div class="avatar-options">
        <div class="avatar-option">
          <input type="radio" id="avatar1" name="avatar" value="anna" checked>
          <label for="avatar1">
            <!-- Fixed image URL -->
            <div style="width: 80px; height: 80px; border-radius: 8px; margin-right: 10px; background: #4CAF50; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
              Anna
            </div>
            <div>
              <strong>Anna</strong><br>
              <span style="font-size: 0.8em; color: #666;">Professional Female Avatar</span>
            </div>
          </label>
        </div>
        <div class="avatar-option">
          <input type="radio" id="avatar2" name="avatar" value="lisa">
          <label for="avatar2">
            <!-- Fixed image URL -->
            <div style="width: 80px; height: 80px; border-radius: 8px; margin-right: 10px; background: #2196F3; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
              Lisa
            </div>
            <div>
              <strong>Lisa</strong><br>
              <span style="font-size: 0.8em; color: #666;">Professional Female Avatar</span>
            </div>
          </label>
        </div>
        <div class="avatar-option">
          <input type="radio" id="avatar3" name="avatar" value="chris">
          <label for="avatar3">
            <!-- Fixed image URL -->
            <div style="width: 80px; height: 80px; border-radius: 8px; margin-right: 10px; background: #FF9800; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
              Chris
            </div>
            <div>
              <strong>Chris</strong><br>
              <span style="font-size: 0.8em; color: #666;">Professional Male Avatar</span>
            </div>
          </label>
        </div>
      </div>
      <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
        <strong>Note:</strong> These are default HeyGen avatar IDs. Check your HeyGen dashboard for available avatars.
      </p>
    </section>

    <!-- Video Section -->
    <section>
      <h2>üé• Generate AI Video with HeyGen</h2>
      <button type="button" id="generateVideoBtn">ü§ñ Generate HeyGen AI Video</button>

      <!-- Status Messages -->
      <div id="statusMessage" style="display: none;"></div>

      <!-- Progress bar -->
      <div id="progressContainer" style="display: none;">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <p id="progressText" style="text-align: center; margin: 5px 0; font-size: 0.9em; color: #666;">Starting...</p>
      </div>

      <video id="video" controls style="display: none;"></video>

      <div id="loadingMessage" style="display:none;text-align:center;margin-top:20px;">
        <div class="spinner"></div>
        <p style="font-size:1.2rem;color:#555;margin-top:10px;">Generating HeyGen AI video, please wait...</p>
        <p style="font-size:0.9rem;color:#777;">This may take 2-3 minutes</p>
      </div>

      <button type="button" id="saveLessonBtn" style="display: none;">üíæ Save Lesson to AWS S3 & Database</button>
    </section>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const urlParams = new URLSearchParams(window.location.search);

      // Get all dynamic fields
      const returnTo = urlParams.get("returnTo") || "/adminright";
      const subtopicId = urlParams.get("subtopicId") || "";
      const parentId = urlParams.get("parentId") || "";
      const rootId = urlParams.get("rootId") || "";
      const dbname = urlParams.get("dbname") || "professional";
      const subjectName = urlParams.get("subjectName") || "";
      const subtopic = urlParams.get("subtopic") || "";
      const description = decodeURIComponent(urlParams.get("description") || "");

      console.log("üìã Received parameters:", {
        subtopicId: subtopicId,
        parentId: parentId,
        rootId: rootId,
        dbname: dbname,
        subjectName: subjectName,
        subtopicName: subtopic
      });

      // Fill UI
      document.getElementById("subtopic").value = subtopic;
      document.getElementById("originalDescription").value = description;

      let s3VideoUrl = "";
      const questions = [];

      // DOM Elements
      const statusMessage = document.getElementById("statusMessage");
      const generateBtn = document.getElementById("generateVideoBtn");
      const saveBtn = document.getElementById("saveLessonBtn");
      const loading = document.getElementById("loadingMessage");
      const video = document.getElementById("video");
      const progressContainer = document.getElementById("progressContainer");
      const progressFill = document.getElementById("progressFill");
      const progressText = document.getElementById("progressText");

      // Add question functionality
      document.getElementById("addQuestionBtn").addEventListener("click", () => {
        const q = document.getElementById("questionInput").value.trim();
        const a = document.getElementById("answerInput").value.trim();

        if (!q || !a) {
          alert("Please enter both question & answer");
          return;
        }

        questions.push({ question: q, answer: a });

        // Clear inputs
        document.getElementById("questionInput").value = "";
        document.getElementById("answerInput").value = "";

        // Update UI
        updateQuestionsDisplay();
        alert(`‚úÖ Interactive question added!`);
      });

      function updateQuestionsDisplay() {
        const container = document.getElementById("addedQuestions");
        const countElement = document.getElementById("questionCount");

        // Update count
        countElement.textContent = questions.length;

        // Clear and rebuild questions list
        container.innerHTML = '';

        questions.forEach((item, index) => {
          const div = document.createElement("div");
          div.className = "question-item";
          div.innerHTML = `
            <strong>Q${index + 1}:</strong> ${item.question}<br/>
            <strong>A:</strong> ${item.answer}
            <button onclick="removeQuestion(${index})" style="margin-left: 10px; background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Remove</button>
          `;
          container.appendChild(div);
        });
      }

      // Add remove question function
      window.removeQuestion = function (index) {
        if (confirm("Remove this question?")) {
          questions.splice(index, 1);
          updateQuestionsDisplay();
        }
      };

      function showStatus(message, type = 'processing') {
        statusMessage.innerHTML = message;
        statusMessage.className = `status-message status-${type}`;
        statusMessage.style.display = 'block';
      }

      function hideStatus() {
        statusMessage.style.display = 'none';
      }

      function updateProgress(percent, text) {
        progressFill.style.width = `${percent}%`;
        progressText.textContent = text;
      }

      // ‚úÖ Generate HeyGen AI Video
      document.getElementById("generateVideoBtn").addEventListener("click", async () => {
        const desc = document.getElementById("customDescription").value.trim() || description;
        const selectedAvatar = document.querySelector('input[name="avatar"]:checked').value;

        if (!desc.trim()) {
          alert("Please enter a description for the AI video");
          return;
        }

        if (!subtopicId) {
          alert("Error: Cannot find subtopic ID");
          return;
        }

        // UI State
        generateBtn.disabled = true;
        generateBtn.textContent = "Generating...";
        loading.style.display = "block";
        video.style.display = "none";
        saveBtn.style.display = "none";
        progressContainer.style.display = "block";
        hideStatus();
        updateProgress(10, "Starting HeyGen video generation...");

        try {
          console.log("üé¨ Starting HeyGen video generation");

          // Step 1: Start video generation
          updateProgress(20, "Initializing HeyGen API...");
          const startResponse = await fetch("https://d3ty37mf4sf9cz.cloudfront.net/generate-hygen-video", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              subtopic: subtopic,
              description: desc,
              questions: questions,
              subtopicId: subtopicId,
              parentId: parentId,
              rootId: rootId,
              dbname: dbname,
              subjectName: subjectName,
              avatar: selectedAvatar
            })
          });

          if (!startResponse.ok) {
            const errorText = await startResponse.text();
            throw new Error(`Failed to start video: HTTP ${startResponse.status} - ${errorText}`);
          }

          const startData = await startResponse.json();
          console.log("‚úÖ Generation started:", startData);

          const jobId = startData.job_id;

          showStatus(
            `üîÑ HeyGen AI video generation started!<br>
            üìù <strong>${startData.subtopic}</strong><br>
            ü§ñ Avatar: ${selectedAvatar}<br>
            ‚è≥ This may take 2-3 minutes...`,
            'processing'
          );

          // Step 2: Poll for job completion
          let jobCompleted = false;
          let pollCount = 0;
          const MAX_POLLS = 60;

          updateProgress(30, "Creating AI video with HeyGen...");

          while (!jobCompleted && pollCount < MAX_POLLS) {
            await new Promise(r => setTimeout(r, 5000)); // Poll every 5 seconds
            pollCount++;

            try {
              updateProgress(30 + (pollCount / MAX_POLLS) * 60, `Processing... (${pollCount}/${MAX_POLLS})`);

              // ‚úÖ FIXED: Correct endpoint for job status
              const statusResponse = await fetch(`https://d3ty37mf4sf9cz.cloudfront.net/api/job-status/${jobId}`);

              if (!statusResponse.ok) {
                console.warn(`‚ö†Ô∏è Status check ${pollCount} failed: HTTP ${statusResponse.status}`);
                continue;
              }

              const jobStatus = await statusResponse.json();
              console.log(`üìä Job status ${pollCount}:`, jobStatus.status);

              if (jobStatus.status === 'completed') {
                // ‚úÖ VIDEO READY!
                s3VideoUrl = jobStatus.videoUrl || jobStatus.s3Url;
                console.log("‚úÖ HeyGen video ready:", s3VideoUrl);

                if (!s3VideoUrl) {
                  throw new Error("No video URL in completed job");
                }

                // Show video and enable save button
                video.style.display = "block";
                video.src = s3VideoUrl;
                saveBtn.style.display = "block";
                progressContainer.style.display = "none";

                if (jobStatus.databaseUpdated) {
                  showStatus(
                    `‚úÖ HeyGen video generated and saved to database!<br>
                    ü§ñ Avatar: ${selectedAvatar}<br>
                    ‚òÅÔ∏è Stored in: AWS S3<br>
                    üíæ Database: ${jobStatus.collection || 'Updated'}`,
                    'success'
                  );
                  saveBtn.style.display = "none"; // Already saved
                  alert(`‚úÖ HeyGen video generated and automatically saved to database!`);
                  
                  // Redirect after 3 seconds
                  setTimeout(() => {
                    const returnUrl = new URL(returnTo, window.location.origin);
                    returnUrl.searchParams.set("saved", "true");
                    returnUrl.searchParams.set("message", "HeyGen+video+generated+and+saved+to+database");
                    returnUrl.searchParams.set("videoUrl", encodeURIComponent(s3VideoUrl));
                    returnUrl.searchParams.set("collection", jobStatus.collection || "unknown");
                    window.location.href = returnUrl.toString();
                  }, 3000);
                } else {
                  showStatus(
                    `‚úÖ HeyGen video generated!<br>
                    ü§ñ Avatar: ${selectedAvatar}<br>
                    ‚òÅÔ∏è Stored in: AWS S3<br>
                    ‚ö†Ô∏è Click "Save Lesson" to save to database`,
                    'success'
                  );
                  saveBtn.style.display = "block"; // Need manual save
                  alert(`‚úÖ HeyGen video generated! Click "Save Lesson to AWS S3 & Database" to save the URL.`);
                }

                jobCompleted = true;
                break;

              } else if (jobStatus.status === 'failed') {
                throw new Error(jobStatus.error || "Video generation failed");
              }

              showStatus(
                `üîÑ Video generation in progress...<br>
                üìù <strong>${subtopic}</strong><br>
                üîÑ ${jobStatus.progress || 'Processing...'}<br>
                ‚è≥ Please wait...`,
                'processing'
              );

            } catch (pollError) {
              console.warn(`‚ö†Ô∏è Poll ${pollCount} failed:`, pollError.message);
            }
          }

          if (!jobCompleted) {
            throw new Error("Video generation took too long. Please try again.");
          }

        } catch (err) {
          console.error("‚ùå HeyGen video generation error:", err);
          progressContainer.style.display = "none";

          showStatus(
            `‚ùå Generation failed<br>
            ${err.message}`,
            'error'
          );
          alert("‚ùå Failed to generate video: " + err.message);
        } finally {
          // Reset UI state
          loading.style.display = "none";
          generateBtn.disabled = false;
          generateBtn.textContent = "ü§ñ Generate HeyGen AI Video";
        }
      });

      // ‚úÖ Save button handler
      document.getElementById("saveLessonBtn").addEventListener("click", async () => {
        try {
          const videoUrl = video.src || s3VideoUrl;
          
          if (!videoUrl) {
            alert("Please generate an AI video first");
            return;
          }

          if (!subtopicId) {
            alert("Error: Cannot find subtopic ID");
            return;
          }

          console.log("üîó Video URL:", videoUrl);
          console.log("üéØ Subtopic ID:", subtopicId);
          
          // Show status
          saveBtn.disabled = true;
          saveBtn.textContent = "Saving...";
          showStatus("üíæ Saving S3 URL to database...", "processing");
          
          try {
            // Call the save endpoint
            const saveResponse = await fetch("https://d3ty37mf4sf9cz.cloudfront.net/api/save-to-db", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                videoUrl: videoUrl,
                subtopic: subtopic,
                subtopicId: subtopicId,
                dbname: dbname,
                subjectName: subjectName
              }),
            });

            const saveData = await saveResponse.json();
            console.log("‚úÖ Save response:", saveData);

            if (saveData.database_updated) {
              showStatus(
                `‚úÖ S3 URL saved to database successfully!<br>
                üìç Location: ${saveData.location}<br>
                üìÅ Collection: ${saveData.collection}`,
                'success'
              );
              saveBtn.textContent = "‚úÖ Saved!";
              saveBtn.disabled = true;
              
              // Redirect after 2 seconds
              setTimeout(() => {
                const returnUrl = new URL(returnTo, window.location.origin);
                returnUrl.searchParams.set("saved", "true");
                returnUrl.searchParams.set("message", "HeyGen+video+S3+URL+saved+to+database");
                returnUrl.searchParams.set("videoUrl", encodeURIComponent(videoUrl));
                returnUrl.searchParams.set("collection", saveData.collection);
                window.location.href = returnUrl.toString();
              }, 2000);
            } else {
              showStatus(
                `‚ö†Ô∏è Video NOT saved to database<br>
                üìù ${saveData.message}<br>
                üîó S3 URL: ${videoUrl.substring(0, 60)}...`,
                'error'
              );
              saveBtn.disabled = false;
              saveBtn.textContent = "üíæ Save Lesson to AWS S3 & Database";
            }

          } catch (err) {
            console.error("‚ùå Save failed:", err);
            showStatus(`‚ùå Save failed: ${err.message}`, 'error');
            saveBtn.disabled = false;
            saveBtn.textContent = "üíæ Save Lesson to AWS S3 & Database";
          }

        } catch (err) {
          console.error("‚ùå Error:", err);
          alert("‚ùå Error: " + err.message);
          saveBtn.disabled = false;
          saveBtn.textContent = "üíæ Save Lesson to AWS S3 & Database";
        }
      });

      // Check database on page load - FIXED endpoint
      if (subtopicId) {
        console.log("üîç Checking if subtopic exists in database...");
        fetch(`https://d3ty37mf4sf9cz.cloudfront.net/api/debug-find-doc?subtopicId=${subtopicId}&dbname=${dbname}`)
          .then(response => response.json())
          .then(data => {
            console.log("üìä Subtopic check result:", data);
            if (data.found) {
              console.log("‚úÖ Subtopic found in collection:", data.collection);
              if (subjectName && data.collection !== subjectName) {
                console.warn(`‚ö†Ô∏è Warning: SubjectName is "${subjectName}" but subtopic found in "${data.collection}"`);
              }
            } else {
              console.log("‚ùå Subtopic not found in any collection");
            }
          })
          .catch(error => console.error("‚ùå Database check failed:", error));
      }
    });
  </script>
</body>
</html>
