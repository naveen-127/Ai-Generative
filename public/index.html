<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interactive AI Teaching Assistant</title>
  <style>
    /* Your existing CSS remains the same */
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
      color: #333;
    }
    header {
      background: #2ecc71;
      color: white;
      padding: 20px;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.8rem;
    }
    main {
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
    }
    section {
      background: #e8f5e9;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #a5d6a7;
      margin-bottom: 20px;
    }
    h2 {
      margin-top: 0;
      font-size: 1.3rem;
      color: #2e7d32;
    }
    label {
      font-weight: 600;
      display: block;
      margin-top: 12px;
      margin-bottom: 5px;
      color: #2e7d32;
    }
    input, textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #81c784;
      font-size: 1rem;
      background: #fff;
      box-sizing: border-box;
    }
    #originalDescription, #customDescription {
      min-height: 100px;
      resize: vertical;
    }
    #subtopic {
      max-width: 400px;
    }
    button {
      margin-top: 15px;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      background: #2ecc71;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s ease;
    }
    button:hover {
      background: #27ae60;
    }
    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }
    .question-item {
      background: #c8e6c9;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
      border-left: 4px solid #2e7d32;
    }
    video {
      display: block;
      width: 100%;
      border-radius: 12px;
      margin-top: 15px;
    }
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      align-items: center;
    }
    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #4CAF50;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    /* ‚úÖ NEW: Interactive Session Styles */
    #interactiveSession {
      display: none;
      background: #ffffff;
      border: 2px solid #4CAF50;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }
    #currentQuestion {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 15px;
      color: #2e7d32;
    }
    #microphoneStatus {
      text-align: center;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      font-weight: bold;
    }
    .mic-listening {
      background: #fff3cd;
      border: 2px solid #ffc107;
      color: #856404;
    }
    .mic-processing {
      background: #d1ecf1;
      border: 2px solid #17a2b8;
      color: #0c5460;
    }
    .mic-success {
      background: #d4edda;
      border: 2px solid #28a745;
      color: #155724;
    }
    .mic-error {
      background: #f8d7da;
      border: 2px solid #dc3545;
      color: #721c24;
    }
    #studentAnswer {
      width: 100%;
      padding: 12px;
      border: 2px solid #81c784;
      border-radius: 8px;
      font-size: 1rem;
      margin: 10px 0;
    }
    #feedbackMessage {
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: center;
      font-weight: bold;
    }
    .feedback-correct {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .feedback-incorrect {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .presenter-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .presenter-option {
      display: flex;
      align-items: center;
      padding: 15px;
      border: 2px solid #81c784;
      border-radius: 10px;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .presenter-option:hover {
      background: #f1f8e9;
      border-color: #4caf50;
    }
    .presenter-option input[type="radio"] {
      margin-right: 15px;
      transform: scale(1.2);
    }
    .presenter-option label {
      display: flex;
      align-items: center;
      cursor: pointer;
      margin: 0;
      width: 100%;
    }
    .status-message {
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: center;
      font-weight: bold;
    }
    .status-processing {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }
    .status-success {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    .status-error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      margin: 10px 0;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #4CAF50;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media(max-width:700px) {
      .two-column {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>üé§ Interactive AI Teaching Assistant</h1>
  </header>

  <main>
    <!-- Lesson Info -->
    <section>
      <h2>Lesson Details</h2>
      <label>Subtopic:</label>
      <input type="text" id="subtopic" readonly />
      <label>Lesson Description:</label>
      <textarea id="originalDescription" readonly></textarea>
      <label>Or Write Your Own:</label>
      <textarea id="customDescription" placeholder="Type your lesson description here..."></textarea>
    </section>

    <!-- Quiz Builder -->
    <section>
      <h2>üìã Interactive Quiz Builder</h2>
      <p style="color: #2e7d32; font-style: italic; margin-bottom: 15px;">
        Students will answer these questions using their microphone!
      </p>
      <div class="two-column">
        <input type="text" id="questionInput" placeholder="Enter question..." />
        <input type="text" id="answerInput" placeholder="Enter correct answer..." />
      </div>
      <button type="button" id="addQuestionBtn">‚ûï Add Interactive Question</button>

      <div id="questionsList">
        <h3>‚úÖ Questions for interactive practice: <span id="questionCount">0</span></h3>
        <div id="addedQuestions"></div>
      </div>
    </section>

    <!-- Presenter Selection -->
    <section>
      <h2>üé≠ Select AI Presenter</h2>
      <div class="presenter-options">
        <div class="presenter-option">
          <input type="radio" id="presenter1" name="presenter" value="v2_public_anita@Os4oKCBIgZ" checked>
          <label for="presenter1">
            <img src="https://clips-presenters.d-id.com/v2/anita/Os4oKCBIgZ/yTLykkbYHr/thumbnail.png" alt="Anita"
              style="width: 80px; height: 80px; border-radius: 8px; margin-right: 10px;">
            <div>
              <strong>Anita</strong><br>
              <span style="font-size: 0.8em; color: #666;">Female - English (Indian)</span>
            </div>
          </label>
        </div>
        <div class="presenter-option">
          <input type="radio" id="presenter2" name="presenter" value="v2_public_lucas@vngv2djh6d">
          <label for="presenter2">
            <img src="https://clips-presenters.d-id.com/v2/lucas/vngv2djh6d/vz7n_w_05r/thumbnail.png" alt="Lucas"
              style="width: 80px; height: 80px; border-radius: 8px; margin-right: 10px;">
            <div>
              <strong>Lucas</strong><br>
              <span style="font-size: 0.8em; color: #666;">Male</span>
            </div>
          </label>
        </div>
      </div>
    </section>

    <!-- Video Section -->
    <section>
      <h2>üé• Lesson Video</h2>
      <button type="button" id="generateVideoBtn">Generate Teaching Video</button>

      <!-- Status Messages -->
      <div id="statusMessage" style="display: none;"></div>

      <!-- Progress bar -->
      <div id="progressContainer" style="display: none;">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <p id="progressText" style="text-align: center; margin: 5px 0; font-size: 0.9em; color: #666;">Starting...</p>
      </div>

      <video id="video" controls style="display: none;"></video>

      <div id="loadingMessage" style="display:none;text-align:center;margin-top:20px;">
        <div class="spinner"></div>
        <p style="font-size:1.2rem;color:#555;margin-top:10px;">Generating your AI video, please wait...</p>
      </div>

      <button type="button" id="saveLessonBtn" style="display: none;">üíæ Save Lesson to AWS S3</button>
    </section>

    <!-- ‚úÖ NEW: Interactive Session Section -->
    <section id="interactiveSession">
      <h2>üé§ Interactive Practice Session</h2>
      <div id="currentQuestion"></div>
      
      <div id="microphoneStatus" class="mic-listening">
        üé§ Click "Start Listening" and speak your answer
      </div>
      
      <textarea id="studentAnswer" placeholder="Or type your answer here..." style="display: none;"></textarea>
      
      <div style="text-align: center;">
        <button type="button" id="startListeningBtn">üé§ Start Listening</button>
        <button type="button" id="submitAnswerBtn" style="display: none;">‚úÖ Submit Answer</button>
        <button type="button" id="nextQuestionBtn" style="display: none;">‚û°Ô∏è Next Question</button>
      </div>
      
      <div id="feedbackMessage" style="display: none;"></div>
      
      <div id="sessionProgress" style="margin-top: 15px;">
        <p>Progress: <span id="currentQuestionNumber">0</span> of <span id="totalQuestions">0</span></p>
      </div>
    </section>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const urlParams = new URLSearchParams(window.location.search);

      // Get all dynamic fields
      const returnTo = urlParams.get("returnTo") || "/adminright";
      const subtopicId = urlParams.get("subtopicId") || "";
      const parentId = urlParams.get("parentId") || "";
      const rootId = urlParams.get("rootId") || "";
      const dbname = urlParams.get("dbname") || "professional";
      const subjectName = urlParams.get("subjectName") || "";
      const subtopic = urlParams.get("subtopic") || "";
      const description = decodeURIComponent(urlParams.get("description") || "");
      const imageUrls = JSON.parse(urlParams.get("imageUrls") || "[]");
      const audioFileId = JSON.parse(urlParams.get("audioFileId") || "[]");

      console.log("üìã Received parameters:", {
        subtopicId: subtopicId,
        parentId: parentId,
        rootId: rootId,
        dbname: dbname,
        subjectName: subjectName,
        subtopicName: subtopic
      });

      // Fill UI
      document.getElementById("subtopic").value = subtopic;
      document.getElementById("originalDescription").value = description;

      let aiVideoUrl = "";
      const questions = [];
      let currentQuestionIndex = 0;
      let recognition = null;

      // DOM Elements
      const statusMessage = document.getElementById("statusMessage");
      const generateBtn = document.getElementById("generateVideoBtn");
      const saveBtn = document.getElementById("saveLessonBtn");
      const loading = document.getElementById("loadingMessage");
      const video = document.getElementById("video");
      const progressContainer = document.getElementById("progressContainer");
      const progressFill = document.getElementById("progressFill");
      const progressText = document.getElementById("progressText");
      
      // ‚úÖ NEW: Interactive Session Elements
      const interactiveSession = document.getElementById("interactiveSession");
      const currentQuestionEl = document.getElementById("currentQuestion");
      const microphoneStatus = document.getElementById("microphoneStatus");
      const studentAnswer = document.getElementById("studentAnswer");
      const startListeningBtn = document.getElementById("startListeningBtn");
      const submitAnswerBtn = document.getElementById("submitAnswerBtn");
      const nextQuestionBtn = document.getElementById("nextQuestionBtn");
      const feedbackMessage = document.getElementById("feedbackMessage");
      const currentQuestionNumber = document.getElementById("currentQuestionNumber");
      const totalQuestions = document.getElementById("totalQuestions");

      // Check database on page load
      console.log("üîç Checking if subtopic exists in database...");
      fetch(`https://d3ty37mf4sf9cz.cloudfront.net/api/debug-subtopic/${subtopicId}?dbname=${dbname}`)
        .then(response => response.json())
        .then(data => {
          console.log("üìä Subtopic check result:", data);
          if (data.found) {
            console.log("‚úÖ Subtopic found:", data.subtopic);
          } else {
            console.log("‚ùå Subtopic not found");
          }
        })
        .catch(error => console.error("‚ùå Database check failed:", error));

      // Add interactive quiz question
      document.getElementById("addQuestionBtn").addEventListener("click", () => {
        const q = document.getElementById("questionInput").value.trim();
        const a = document.getElementById("answerInput").value.trim();

        if (!q || !a) {
          alert("Please enter both question & answer");
          return;
        }

        questions.push({ question: q, answer: a });

        // Clear inputs
        document.getElementById("questionInput").value = "";
        document.getElementById("answerInput").value = "";

        // Update UI
        updateQuestionsDisplay();

        alert(`‚úÖ Interactive question added!\n\nStudents will answer this using voice or text!`);
      });

      function updateQuestionsDisplay() {
        const container = document.getElementById("addedQuestions");
        const countElement = document.getElementById("questionCount");

        // Update count
        countElement.textContent = questions.length;

        // Clear and rebuild questions list
        container.innerHTML = '';

        questions.forEach((item, index) => {
          const div = document.createElement("div");
          div.className = "question-item";
          div.innerHTML = `
            <strong>Q${index + 1}:</strong> ${item.question}<br/>
            <strong>A:</strong> ${item.answer}
            <button onclick="removeQuestion(${index})" style="margin-left: 10px; background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Remove</button>
          `;
          container.appendChild(div);
        });
      }

      // Add remove question function
      window.removeQuestion = function (index) {
        if (confirm("Remove this question from the video?")) {
          questions.splice(index, 1);
          updateQuestionsDisplay();
        }
      };

      function showStatus(message, type = 'processing') {
        statusMessage.innerHTML = message;
        statusMessage.className = `status-message status-${type}`;
        statusMessage.style.display = 'block';
      }

      function hideStatus() {
        statusMessage.style.display = 'none';
      }

      function updateProgress(percent, text) {
        progressFill.style.width = `${percent}%`;
        progressText.textContent = text;
      }

      // ‚úÖ MODIFIED: Generate teaching video (without interactive parts)
      document.getElementById("generateVideoBtn").addEventListener("click", async () => {
        const desc = document.getElementById("customDescription").value.trim() || description;
        const selectedPresenter = document.querySelector('input[name="presenter"]:checked').value;

        if (!desc.trim()) {
          alert("Please enter a description for the AI video");
          return;
        }

        // UI State
        generateBtn.disabled = true;
        generateBtn.textContent = "Generating...";
        loading.style.display = "block";
        video.style.display = "none";
        saveBtn.style.display = "none";
        interactiveSession.style.display = "none";
        progressContainer.style.display = "block";
        hideStatus();
        updateProgress(10, "Starting video generation...");

        try {
          console.log("üé¨ Starting teaching video generation");

          // Create teaching-only script (no questions in video)
          let teachingScript = desc;
          teachingScript += "\n\nNow, let's practice what you've learned with some interactive questions.";

          console.log("üìù Teaching script prepared");

          // Step 1: Start video generation
          updateProgress(20, "Initializing D-ID API...");
          const startResponse = await fetch("https://d3ty37mf4sf9cz.cloudfront.net/generate-and-upload", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              subtopic: subtopic,
              description: teachingScript,
              questions: [], // No questions in video - they'll be interactive
              presenter_id: selectedPresenter
            })
          });

          if (!startResponse.ok) {
            const errorText = await startResponse.text();
            throw new Error(`Failed to start video: HTTP ${startResponse.status}`);
          }

          const startData = await startResponse.json();
          console.log("‚úÖ Generation started:", startData);

          const jobId = startData.job_id;

          showStatus(
            `üîÑ Teaching video generation started!<br>
            üìù <strong>${startData.subtopic}</strong><br>
            ‚è≥ This may take 2-3 minutes...`,
            'processing'
          );

          // Step 2: Poll for job completion
          let jobCompleted = false;
          let pollCount = 0;
          const MAX_POLLS = 60;

          updateProgress(30, "Creating teaching video...");

          while (!jobCompleted && pollCount < MAX_POLLS) {
            await new Promise(r => setTimeout(r, 3000));
            pollCount++;

            try {
              updateProgress(30 + (pollCount / MAX_POLLS) * 60, `Processing video... (${pollCount}/${MAX_POLLS})`);

              const statusResponse = await fetch(`https://d3ty37mf4sf9cz.cloudfront.net/api/job-status/${jobId}`);

              if (!statusResponse.ok) {
                console.warn(`‚ö†Ô∏è Status check ${pollCount} failed: HTTP ${statusResponse.status}`);
                continue;
              }

              const jobStatus = await statusResponse.json();
              console.log(`üìä Job status ${pollCount}:`, jobStatus.status);

              if (jobStatus.status === 'completed') {
                // ‚úÖ VIDEO READY!
                aiVideoUrl = jobStatus.videoUrl;
                console.log("‚úÖ Teaching video ready:", aiVideoUrl);

                if (!aiVideoUrl) {
                  throw new Error("No video URL in completed job");
                }

                // Store video URL and show in UI
                localStorage.setItem("generatedAIVideoUrl", aiVideoUrl);

                // Show video and enable buttons
                video.style.display = "block";
                video.src = aiVideoUrl;
                saveBtn.style.display = "block";
                
                // Show interactive session if there are questions
                if (questions.length > 0) {
                  interactiveSession.style.display = "block";
                  startInteractiveSession();
                }
                
                progressContainer.style.display = "none";

                showStatus(
                  `‚úÖ Teaching video generated successfully!<br>
                  üé≠ Presenter: ${selectedPresenter}<br>
                  ‚ùì ${questions.length} interactive questions ready`,
                  'success'
                );

                alert(`‚úÖ Teaching video generated! ${questions.length > 0 ? 'Start the interactive session to practice questions.' : ''}`);
                jobCompleted = true;
                break;

              } else if (jobStatus.status === 'failed') {
                throw new Error(jobStatus.error || "Video generation failed");
              }

              showStatus(
                `üîÑ Video generation in progress...<br>
                üìù <strong>${subtopic}</strong><br>
                üîÑ ${jobStatus.progress || 'Processing...'}<br>
                ‚è≥ Please wait...`,
                'processing'
              );

            } catch (pollError) {
              console.warn(`‚ö†Ô∏è Poll ${pollCount} failed:`, pollError.message);
            }
          }

          if (!jobCompleted) {
            throw new Error("Video generation took too long. Please try again.");
          }

        } catch (err) {
          console.error("‚ùå AI Video generation error:", err);
          progressContainer.style.display = "none";

          showStatus(
            `‚ùå Generation failed<br>
            ${err.message}`,
            'error'
          );
          alert("‚ùå Failed to generate video: " + err.message);
        } finally {
          // Reset UI state
          loading.style.display = "none";
          generateBtn.disabled = false;
          generateBtn.textContent = "Generate Teaching Video";
        }
      });

      // ‚úÖ NEW: Interactive Session Functions
      function startInteractiveSession() {
        currentQuestionIndex = 0;
        totalQuestions.textContent = questions.length;
        showQuestion(currentQuestionIndex);
      }

      function showQuestion(index) {
        if (index >= questions.length) {
          endSession();
          return;
        }

        const question = questions[index];
        currentQuestionEl.innerHTML = `<strong>Question ${index + 1}:</strong> ${question.question}`;
        currentQuestionNumber.textContent = index + 1;
        
        // Reset UI
        microphoneStatus.className = "mic-listening";
        microphoneStatus.innerHTML = "üé§ Click 'Start Listening' and speak your answer";
        studentAnswer.style.display = "none";
        studentAnswer.value = "";
        startListeningBtn.style.display = "inline-block";
        submitAnswerBtn.style.display = "none";
        nextQuestionBtn.style.display = "none";
        feedbackMessage.style.display = "none";
      }

      function initializeSpeechRecognition() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
          alert("Speech recognition is not supported in this browser. Please use Chrome or Edge.");
          return null;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onstart = function() {
          microphoneStatus.className = "mic-listening";
          microphoneStatus.innerHTML = "üé§ Listening... Speak now!";
        };

        recognition.onresult = function(event) {
          const transcript = event.results[0][0].transcript;
          studentAnswer.value = transcript;
          studentAnswer.style.display = "block";
          startListeningBtn.style.display = "none";
          submitAnswerBtn.style.display = "inline-block";
          
          microphoneStatus.className = "mic-success";
          microphoneStatus.innerHTML = "‚úÖ Speech captured! Click 'Submit Answer' or speak again.";
        };

        recognition.onerror = function(event) {
          console.error("Speech recognition error:", event.error);
          microphoneStatus.className = "mic-error";
          microphoneStatus.innerHTML = `‚ùå Error: ${event.error}. Please type your answer.`;
          studentAnswer.style.display = "block";
          studentAnswer.placeholder = "Please type your answer here...";
          startListeningBtn.style.display = "none";
          submitAnswerBtn.style.display = "inline-block";
        };

        recognition.onend = function() {
          // Auto-restart if still in listening mode
          if (microphoneStatus.classList.contains("mic-listening")) {
            setTimeout(() => {
              if (microphoneStatus.classList.contains("mic-listening")) {
                recognition.start();
              }
            }, 100);
          }
        };

        return recognition;
      }

      // Start listening button
      startListeningBtn.addEventListener("click", () => {
        if (!recognition) {
          recognition = initializeSpeechRecognition();
        }
        
        if (recognition) {
          try {
            recognition.start();
          } catch (error) {
            console.error("Recognition start error:", error);
            microphoneStatus.className = "mic-error";
            microphoneStatus.innerHTML = "‚ùå Cannot access microphone. Please type your answer.";
            studentAnswer.style.display = "block";
            studentAnswer.placeholder = "Please type your answer here...";
            startListeningBtn.style.display = "none";
            submitAnswerBtn.style.display = "inline-block";
          }
        }
      });

      // Submit answer button
      submitAnswerBtn.addEventListener("click", () => {
        const userAnswer = studentAnswer.value.trim();
        if (!userAnswer) {
          alert("Please provide an answer first");
          return;
        }

        evaluateAnswer(userAnswer);
      });

      function evaluateAnswer(userAnswer) {
        const currentQuestion = questions[currentQuestionIndex];
        const correctAnswer = currentQuestion.answer.toLowerCase();
        const userAnswerLower = userAnswer.toLowerCase();

        // Simple evaluation - you can make this more sophisticated
        const isCorrect = userAnswerLower.includes(correctAnswer) || 
                         correctAnswer.includes(userAnswerLower) ||
                         calculateSimilarity(userAnswerLower, correctAnswer) > 0.7;

        // Show feedback
        feedbackMessage.style.display = "block";
        if (isCorrect) {
          feedbackMessage.className = "feedback-correct";
          feedbackMessage.innerHTML = `‚úÖ Correct! Well done!<br>The answer is: ${currentQuestion.answer}`;
        } else {
          feedbackMessage.className = "feedback-incorrect";
          feedbackMessage.innerHTML = `‚ùå Not quite right.<br>The correct answer is: ${currentQuestion.answer}`;
        }

        // Enable next question
        nextQuestionBtn.style.display = "inline-block";
        submitAnswerBtn.style.display = "none";
      }

      // Simple similarity calculation
      function calculateSimilarity(str1, str2) {
        const words1 = str1.split(' ');
        const words2 = str2.split(' ');
        const commonWords = words1.filter(word => words2.includes(word));
        return commonWords.length / Math.max(words1.length, words2.length);
      }

      // Next question button
      nextQuestionBtn.addEventListener("click", () => {
        currentQuestionIndex++;
        showQuestion(currentQuestionIndex);
      });

      function endSession() {
        interactiveSession.innerHTML = `
          <h2>üéâ Session Complete!</h2>
          <div class="feedback-correct" style="padding: 20px; text-align: center;">
            <h3>‚úÖ Excellent work!</h3>
            <p>You've completed all ${questions.length} practice questions.</p>
            <p>Keep up the great learning!</p>
          </div>
          <button type="button" onclick="location.reload()" style="margin-top: 15px;">
            üîÑ Start New Session
          </button>
        `;
      }

      // ‚úÖ SIMPLIFIED: Just redirect after video generation (database is already saved)
document.getElementById("saveLessonBtn").addEventListener("click", async () => {
  try {
    // Get the S3 URL from the video element (this is already the S3 URL)
    const s3VideoUrl = video.src;
    
    if (!s3VideoUrl) {
      alert("Please generate an AI video first");
      return;
    }

    if (!subtopicId) {
      alert("Error: Cannot find subtopic ID");
      return;
    }

    console.log("üîó S3 Video URL to verify:", s3VideoUrl);
    
    // Show status
    saveBtn.disabled = true;
    saveBtn.textContent = "‚úÖ Already Saved!";
    showStatus("‚úÖ Video already saved to database automatically!", "success");
    
    // Clean up localStorage
    localStorage.removeItem("generatedAIVideoUrl");
    
    // Redirect back with success message
    setTimeout(() => {
      const returnUrl = new URL(returnTo, window.location.origin);
      returnUrl.searchParams.set("saved", "true");
      returnUrl.searchParams.set("message", "AI+video+generated+and+saved+to+S3+automatically");
      returnUrl.searchParams.set("videoUrl", encodeURIComponent(s3VideoUrl));
      returnUrl.searchParams.set("storage", "aws_s3");
      
      window.location.href = returnUrl.toString();
    }, 2000);

  } catch (err) {
    console.error("‚ùå Error in save lesson:", err);
    alert("‚ùå Error: " + err.message);
    saveBtn.disabled = false;
    saveBtn.textContent = "üíæ Save Lesson to AWS S3";
  }
});
    });
  </script>
</body>
</html>
